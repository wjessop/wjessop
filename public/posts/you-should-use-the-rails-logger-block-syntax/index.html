<!doctype html>
<html lang="en">
	<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="/sass/styles.css">

		<link href="http://localhost:1313/rss.xml" rel="alternate" type="application/rss+xml" title="All posts | Will Jessop&#39;s Writings" />
		<title>
			You should use the Ruby on Rails logger block syntax
			</title>
		<meta
			name="description"
			content="The BUFFERS option to Postgres&#39; EXPLAIN command can help you work out where queries are using lots of IO. learn how to use this to optimize your SQL."
		/>
		<meta name="author" content="Will Jessop">
	</head>
	<body>
		<h1>Will Jessop&#39;s Writings</h1>
		<em></srong><p>Sailing, Food, Programming, Technology, and other things</p></em>
		<nav id="nav" class="nav justify-content-center">
	|
<a class="nav-link" href="/">Home</a> |
<a class="nav-link" href="/posts/">Posts</a> |
<a class="nav-link" href="/tags/">Tags</a> |
</nav>


		<div class="open-to-contracts">
		Do you have a Ruby on Rails application you'd like to be faster, more scalable, or just upgraded safely?
		I'm currently open to new contracts doing Ruby on Rails and Postgres scaling and performance work, and Rails upgrades.
		Contact me at <a href="mailto:will@willj.net?subject=Contract%20opportunity">will@willj.net</a> to get started.
		</div>
		<time datetime="2024-07-09">Tuesday, July 9, 2024</time>
	|
	tags:<a href="http://localhost:1313/tags/programming">programming</a> <a href="http://localhost:1313/tags/ruby">ruby</a> <a href="http://localhost:1313/tags/rails">rails</a> <a href="http://localhost:1313/tags/ruby-on-rails">ruby on rails</a> <a href="http://localhost:1313/tags/performance">performance</a> <a href="http://localhost:1313/tags/tech">tech</a> 
	<hr />

	<h2>DRAFT: You should use the Ruby on Rails logger block syntax</h2>

	<article>
		<h2 id="summary">Summary</h2>
<p>Passing strings to the Rails logger methods (eg. <code>Rails.logger.info(…)</code>) causes unecessary object allocations, and if you&rsquo;re calling methods to generate data for your log messages then it can cause unecessary CPU work too. In this post I&rsquo;ll show you how to use block syntax when using your logger with Rails to save object allocations and CPU time.</p>
<h2 id="the-context">The Context</h2>
<p>When you&rsquo;re logging in Ruby on Rails log messages sent with a level above the currently configured log level will not be logged. The default in production is to log at <code>info</code> or below, so anything logged at debug level will not be output to the logs:</p>
<pre tabindex="0"><code>debug  ⬆️ Ignored
-----------------
info   ⬇️  Logged
warn
error
fatal
unknown
</code></pre><p>The log level can be set in the environment configs, from <code>config/environments/production.rb</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>config<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">.</span>fetch(<span style="color:#e6db74">&#34;RAILS_LOG_LEVEL&#34;</span>, <span style="color:#e6db74">&#34;info&#34;</span>)
</span></span></code></pre></div><p>The log level can also be changed at any time, including in the Rails console, by setting the log level directly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>level <span style="color:#f92672">=</span> <span style="color:#e6db74">:warn</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:warn</span>
</span></span></code></pre></div><h2 id="the-problem---object-allocations-for-unused-logs">The problem - Object allocations for unused logs</h2>
<aside>
For these examples going to be using the excellent <a href="https://github.com/srawlins/allocation_stats">allocation_stats ruby gem</a> to get object allocation counts.
</aside>
<p>Let&rsquo;s say you want to log some debug data for an API call that a user is making. You might do something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>debug <span style="color:#e6db74">&#34;Processed API request to host </span><span style="color:#e6db74">#{</span>somehost<span style="color:#e6db74">}</span><span style="color:#e6db74"> for user \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">): status: </span><span style="color:#e6db74">#{</span>request_status<span style="color:#e6db74">}</span><span style="color:#e6db74"> user_details: </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>to_json<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>You push this code to production, it&rsquo;s useful to have a way to debug user API issues just by setting the Rails log level to <code>debug</code> from <code>info</code> using the <code>RAILS_LOG_LEVEL</code> environment variable, you can always set it back to <code>info</code> when you&rsquo;re done. Let&rsquo;s look at what this statement allocates when the application is logging at the <code>debug</code> level:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># Set the log level</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>level <span style="color:#f92672">=</span> <span style="color:#e6db74">:debug</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:debug</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Do the logging</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">AllocationStats</span><span style="color:#f92672">.</span>trace {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>debug <span style="color:#e6db74">&#34;Processed API request to \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      host </span><span style="color:#e6db74">#{</span>somehost<span style="color:#e6db74">}</span><span style="color:#e6db74"> for user </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">): status: </span><span style="color:#e6db74">#{</span>request_status<span style="color:#e6db74">}</span><span style="color:#e6db74"> \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      user_details: </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>to_json<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Processed</span> <span style="color:#66d9ef">API</span> request to host <span style="color:#66d9ef">for</span> user <span style="color:#66d9ef">Slartibartfast</span> (<span style="color:#ae81ff">42</span>): <span style="color:#e6db74">status</span>: <span style="color:#66d9ef">DENIED</span> <span style="color:#e6db74">user_details</span>: {<span style="color:#e6db74">&#34;id&#34;</span>:<span style="color:#ae81ff">42</span>,<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#e6db74">:&#34;Slartibartfast&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#e6db74">:&#34;s.bartfast@magrathea.biz&#34;</span>,<span style="color:#e6db74">&#34;favourite_colour&#34;</span><span style="color:#e6db74">:&#34;blue&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#75715e">#&lt;AllocationStats::Allocation:0x000000015489fe18 @object=#&lt;Proc:0x000000015471e9e0 activesupport-7.1.3.4/lib/active_support/broadcas...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get an allocation count, source paths shortened for brevity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> puts stats<span style="color:#f92672">.</span>allocations<span style="color:#f92672">.</span>group_by(<span style="color:#e6db74">:sourcefile</span>, <span style="color:#e6db74">:sourceline</span>, <span style="color:#e6db74">:class</span>)<span style="color:#f92672">.</span>to_text
</span></span><span style="display:flex;"><span>                           sourcefile                             sourceline                      <span style="color:#66d9ef">class</span>                      count
</span></span><span style="display:flex;"><span><span style="color:#f92672">-----------------------------------------------------------------</span> <span style="color:#f92672">----------</span>  <span style="color:#f92672">---------------------------------------------</span>  <span style="color:#f92672">-----</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>broadcast_logger<span style="color:#f92672">.</span>rb             <span style="color:#ae81ff">231</span>  <span style="color:#66d9ef">Proc</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>(irb)                                                                     <span style="color:#ae81ff">45</span>  Array                                              <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ruby<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>common<span style="color:#f92672">.</span>rb                                                <span style="color:#ae81ff">303</span>  <span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Ext</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Generator</span><span style="color:#f92672">::</span><span style="color:#66d9ef">State</span>                        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>core_ext<span style="color:#f92672">/</span>object<span style="color:#f92672">/</span>json<span style="color:#f92672">.</span>rb         <span style="color:#ae81ff">188</span>  String                                             <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                 <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">ActiveSupport</span><span style="color:#f92672">::</span><span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Encoding</span><span style="color:#f92672">::</span><span style="color:#66d9ef">JSONGemEncoder</span>      <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>(irb)                                                                     <span style="color:#ae81ff">13</span>  String                                             <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>(irb)                                                                     <span style="color:#ae81ff">45</span>  String                                             <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">internal</span>:timev<span style="color:#f92672">&gt;</span>                                                         <span style="color:#ae81ff">226</span>  <span style="color:#66d9ef">Time</span>                                               <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>ruby<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>common<span style="color:#f92672">.</span>rb                                                <span style="color:#ae81ff">305</span>  String                                             <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                 <span style="color:#ae81ff">92</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                 <span style="color:#ae81ff">77</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>core_ext<span style="color:#f92672">/</span>object<span style="color:#f92672">/</span>json<span style="color:#f92672">.</span>rb         <span style="color:#ae81ff">186</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>core_ext<span style="color:#f92672">/</span>object<span style="color:#f92672">/</span>json<span style="color:#f92672">.</span>rb          <span style="color:#ae81ff">78</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                 <span style="color:#ae81ff">33</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ruby<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>logger<span style="color:#f92672">/</span>log_device<span style="color:#f92672">.</span>rb                                           <span style="color:#ae81ff">42</span>  String                                             <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>logger<span style="color:#f92672">.</span>rb                        <span style="color:#ae81ff">38</span>  String                                             <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>ruby<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>logger<span style="color:#f92672">/</span>log_device<span style="color:#f92672">.</span>rb                                          <span style="color:#ae81ff">128</span>  <span style="color:#66d9ef">File</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Stat</span>                                         <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>This is fine! We&rsquo;re logging some data, the Ruby VM is doing work and allocates objects. Let&rsquo;s look at what happens when we change the log level to <code>info</code> when we&rsquo;re done debugging:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># Set the log level</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>level <span style="color:#f92672">=</span> <span style="color:#e6db74">:info</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:info</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Do the logging</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">AllocationStats</span><span style="color:#f92672">.</span>trace {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>debug <span style="color:#e6db74">&#34;Processed API request to \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      host </span><span style="color:#e6db74">#{</span>somehost<span style="color:#e6db74">}</span><span style="color:#e6db74"> for user </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">): status: </span><span style="color:#e6db74">#{</span>request_status<span style="color:#e6db74">}</span><span style="color:#e6db74"> \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      user_details: </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>to_json<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#75715e">#&lt;AllocationStats::Allocation:0x000000015489fd28 @object=#&lt;Proc:0x000000015471e648 activesupport-7.1.3.4/lib/active_support/broadcas...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get an allocation count, source paths shortened for brevity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> puts stats<span style="color:#f92672">.</span>allocations<span style="color:#f92672">.</span>group_by(<span style="color:#e6db74">:sourcefile</span>, <span style="color:#e6db74">:sourceline</span>, <span style="color:#e6db74">:class</span>)<span style="color:#f92672">.</span>to_text
</span></span><span style="display:flex;"><span>                           sourcefile                              sourceline                      <span style="color:#66d9ef">class</span>                      count
</span></span><span style="display:flex;"><span><span style="color:#f92672">-----------------------------------------------------------------</span>  <span style="color:#f92672">----------</span>  <span style="color:#f92672">---------------------------------------------</span>  <span style="color:#f92672">-----</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>broadcast_logger<span style="color:#f92672">.</span>rb              <span style="color:#ae81ff">231</span>  <span style="color:#66d9ef">Proc</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>(irb)                                                                      <span style="color:#ae81ff">48</span>  Array                                              <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#66d9ef">Users</span><span style="color:#f92672">/</span>will<span style="color:#f92672">/.</span>rbenv<span style="color:#f92672">/</span>versions<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>ruby<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>common<span style="color:#f92672">.</span>rb           <span style="color:#ae81ff">303</span>  <span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Ext</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Generator</span><span style="color:#f92672">::</span><span style="color:#66d9ef">State</span>                        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>core_ext<span style="color:#f92672">/</span>object<span style="color:#f92672">/</span>json<span style="color:#f92672">.</span>rb          <span style="color:#ae81ff">188</span>  String                                             <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">ActiveSupport</span><span style="color:#f92672">::</span><span style="color:#66d9ef">JSON</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Encoding</span><span style="color:#f92672">::</span><span style="color:#66d9ef">JSONGemEncoder</span>      <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>(irb)                                                                      <span style="color:#ae81ff">13</span>  String                                             <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>(irb)                                                                      <span style="color:#ae81ff">48</span>  String                                             <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#66d9ef">Users</span><span style="color:#f92672">/</span>will<span style="color:#f92672">/.</span>rbenv<span style="color:#f92672">/</span>versions<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>ruby<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span><span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>common<span style="color:#f92672">.</span>rb           <span style="color:#ae81ff">305</span>  String                                             <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                  <span style="color:#ae81ff">92</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                  <span style="color:#ae81ff">77</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>core_ext<span style="color:#f92672">/</span>object<span style="color:#f92672">/</span>json<span style="color:#f92672">.</span>rb          <span style="color:#ae81ff">186</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>core_ext<span style="color:#f92672">/</span>object<span style="color:#f92672">/</span>json<span style="color:#f92672">.</span>rb           <span style="color:#ae81ff">78</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>json<span style="color:#f92672">/</span>encoding<span style="color:#f92672">.</span>rb                  <span style="color:#ae81ff">33</span>  <span style="color:#66d9ef">Hash</span>                                               <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>This code didn&rsquo;t log anything beacuse the log level is set to <code>info</code> and we called the <code>debug</code> log level method, however <strong>we still allocated almost as many objects!</strong>.</p>
<h2 id="why-this-happens">Why this happens</h2>
<p>When we call <code>Rails.logger.debug</code> with a string, say <code>&quot;Hello #{name}, here's some #{generated_data}!&quot;</code>, the string is created as an object, including any interpolation that is required which may include methods that are called to retrieve or generate the data which also allocates objects. This happens before the string is passed to the method <em>regardless of the current log level</em>, it is up to the logger when passed this now created string to decide if it is going to log it or not. That&rsquo;s wasteful!</p>
<h2 id="the-solution-passing-a-block-to-the-logger">The solution, passing a block to the logger</h2>
<p>Let&rsquo;s run that debug code again but this time pass a block to the logger:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># Set the log level</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>level <span style="color:#f92672">=</span> <span style="color:#e6db74">:info</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:info</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Do the logging</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">AllocationStats</span><span style="color:#f92672">.</span>trace {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>debug { <span style="color:#e6db74">&#34;Processed API request to \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      host </span><span style="color:#e6db74">#{</span>somehost<span style="color:#e6db74">}</span><span style="color:#e6db74"> for user </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">): status: </span><span style="color:#e6db74">#{</span>request_status<span style="color:#e6db74">}</span><span style="color:#e6db74"> \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      user_details: </span><span style="color:#e6db74">#{</span>user<span style="color:#f92672">.</span>to_json<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#75715e">#&lt;AllocationStats::Allocation:0x000000015489ffa8 @object=#&lt;Proc:0x000000015471ea58 /Users/will/.rbenv/versions/3.3.0/lib/ruby/gems/3.3.0/gems/activesupport-7.1.3.4/lib/active_support/broadcas...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get an allocation count, source paths shortened for brevity</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> puts stats<span style="color:#f92672">.</span>allocations<span style="color:#f92672">.</span>group_by(<span style="color:#e6db74">:sourcefile</span>, <span style="color:#e6db74">:sourceline</span>, <span style="color:#e6db74">:class</span>)<span style="color:#f92672">.</span>to_text
</span></span><span style="display:flex;"><span>                          sourcefile                          sourceline  <span style="color:#66d9ef">class</span>  count
</span></span><span style="display:flex;"><span><span style="color:#f92672">------------------------------------------------------------</span>  <span style="color:#f92672">----------</span>  <span style="color:#f92672">-----</span>  <span style="color:#f92672">-----</span>
</span></span><span style="display:flex;"><span>activesupport<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>active_support<span style="color:#f92672">/</span>broadcast_logger<span style="color:#f92672">.</span>rb         <span style="color:#ae81ff">231</span>  <span style="color:#66d9ef">Proc</span>       <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>(irb)                                                                 <span style="color:#ae81ff">51</span>  Array      <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>That&rsquo;s a lot better, we&rsquo;re still not logging anything but the allocations are now significantly reduced. Ideally we&rsquo;d allocate zero objects when logging nothing, but allocating three is a lot better than what we were allocationg before.</p>
<p>This works because when you pass a block to the logger method (<code>debug</code> in this case) the block will only be called if the log level is currently being logged. We had set the log level to <code>info</code> which meant that the block passed to the <code>debug</code> method was never called, and the object allocations to generate the string never happened.</p>
<h2 id="why-should-i-care">Why should I care?</h2>
<p>The examples given here are admittedly trivial (and a little contrived to show the difference), and for an application that doesn&rsquo;t log much or doesn&rsquo;t get much traffic then the benefit is going to be tiny, but the effort involved in making the change to block syntax is <em>really</em> small, it&rsquo;s not detrimental to the code readability either. Small applications can eventually grow into large ones, a handful of requests per second can change to thousands, and if that happens the block syntax can make a difference and you&rsquo;ll likely be glad you made it a habit.</p>

	</article>


		<footer>
	<hr>
	<p>You can contact me by <a href="mailto:will@willj.net">Email</a> and find me on <a href="https://github.com/wjessop/">Github</a>, <a rel="me" href="https://ruby.social/@wj">Mastodon</a>, and <a href="https://twitter.com/will_j">Twitter</a> (now largely abandoned).</p>
</footer>

	</body>
</html>
